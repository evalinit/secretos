<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>LosÂ Secretos</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{--bg:#141414;--fg:#f3f3f3;--accent:#009dff;--card:#242424;--gap:.9rem;--br:8px}
*{box-sizing:border-box;font-family:system-ui,Arial}
body{background:var(--bg);color:var(--fg);margin:1rem;max-width:42rem}
#top{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem}
#top h1{margin:0;font-size:1.7rem;flex:1}
a.link{font-size:.9rem;color:var(--accent);text-decoration:none;cursor:pointer}
a.link:hover{text-decoration:underline}
label.chk{display:flex;align-items:center;gap:.35rem;font-size:.9rem}
input[type=checkbox]{width:auto;height:1.05rem;cursor:pointer}
input,button{width:100%;padding:.55rem;font-size:1rem;border-radius:var(--br);border:1px solid #444;background:#101010;color:var(--fg)}
button{background:var(--accent);cursor:pointer;border:none}
button[disabled]{opacity:.5;cursor:default}
label.stack{display:block;margin-top:var(--gap)}
#toolbar{display:flex;gap:.8rem;margin:calc(var(--gap)*1.5) 0 var(--gap)}
#toolbar input{flex:1}
#toolbar button{flex:0 0 3rem}
.card{background:var(--card);border:1px solid #333;border-radius:var(--br);padding:1rem;margin-bottom:var(--gap);position:relative}
.card h2{margin:0 0 .45rem;font-size:1rem}
.card p{margin:0;font-family:monospace;word-break:break-all}
.btn{position:absolute;width:1.7rem;height:1.7rem;border:none;border-radius:50%;font-weight:bold;line-height:1.7rem;padding:0;color:#fff;cursor:pointer}
.del{top:.4rem;right:.4rem;background:#e33}
.copy{bottom:.4rem;right:.4rem;background:#666;font-size:.8rem}
.hidden{display:none}
.small{font-size:.9rem;opacity:.8}
.err{color:#e55;font-size:.95rem;margin-top:.6rem}
#toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#444;padding:.5rem 1rem;border-radius:var(--br);opacity:0;transition:opacity .3s}
label.stack:last-of-type{margin-bottom:var(--gap);}
</style>

<!-- top bar -->
<div id="top">
  <h1>LosÂ Secretos</h1>
  <a id="logout"    class="link hidden">LogÂ out</a>
  <span>|</span>
  <a id="uninstall" class="link">Uninstall</a>
  <span>|</span>
  <label class="chk">Remember Passphrase<input id="remember" type="checkbox"></label>
</div>

<!-- setup -->
<section id="setup" class="hidden">
  <p class="small">Create a PAT with <code>ContentsÂ RW</code> on your private <code>vault</code> repo and paste it:</p>
  <label class="stack">PAT<input id="pat" type="password"></label>
  <label class="stack">Passphrase<input id="spw" type="password"></label>
  <button id="install">Install</button>
  <p id="smsg" class="err hidden"></p>
</section>

<!-- unlock -->
<section id="unlock" class="hidden">
  <label class="stack">Passphrase<input id="pw" type="password"></label>
  <button id="go">Unlock</button>
  <p id="umsg" class="err hidden"></p>
</section>

<!-- app -->
<section id="app" class="hidden">
  <div id="toolbar">
    <input id="filter" placeholder="filterâ€¦">
    <button id="add">ï¼‹</button>
  </div>
  <div id="grid"></div>
</section>

<div id="toast">âœ“Â Saved</div>

<script>
document.addEventListener('DOMContentLoaded',init);

function init(){
const $=i=>document.getElementById(i),
CFG='secretos-config',PASS='secretos-pass',
API='application/vnd.github+json',
b64=a=>btoa(String.fromCharCode(...new Uint8Array(a))),
ab =s=>Uint8Array.from(atob(s),c=>c.charCodeAt()).buffer;

let pass,token,user,sha='',entries=[];

/* crypto */
async function kdf(p,s){const b=await crypto.subtle.importKey('raw',new TextEncoder().encode(p),'PBKDF2',0,['deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt:s,iterations:250e3,hash:'SHA-256'},b,{name:'AES-GCM',length:256},0,['encrypt','decrypt'])}
const enc=async o=>{const iv=crypto.getRandomValues(new Uint8Array(12)),salt=crypto.getRandomValues(new Uint8Array(16)),ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},await kdf(pass,salt),new TextEncoder().encode(JSON.stringify(o)));return{iv:b64(iv),salt:b64(salt),ct:b64(ct)}}
const dec=async o=>JSON.parse(new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:ab(o.iv)},await kdf(pass,ab(o.salt)),ab(o.ct))))

const toast=m=>{const t=$('toast');t.textContent=m;t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1200)}
const cfg =()=>JSON.parse(localStorage.getItem(CFG)||'null');
const gh =(u,o={})=>fetch(u,{...o,headers:{Authorization:`Bearer ${token}`,Accept:API,'X-GitHub-Api-Version':'2022-11-28'}})

/* render grid */
const grid=$('grid');
function render(q=''){grid.innerHTML='';entries.filter(e=>e.k.toLowerCase().includes(q)||e.v.toLowerCase().includes(q)).forEach((e,i)=>grid.insertAdjacentHTML('beforeend',`<div class="card"><button class="btn del" data-i=${i}>Ã—</button><h2>${e.k}</h2><p class="sec" data-i=${i}>${'â€¢'.repeat(e.v.length)}</p><button class="btn copy" data-i=${i}>ðŸ“‹</button></div>`))}
$('filter').oninput=e=>render(e.target.value.toLowerCase())
grid.onclick=e=>{
  const i=e.target.dataset.i;
  if(e.target.classList.contains('del')){if(!confirm(`Delete â€œ${entries[i].k}â€ ?`))return;entries.splice(i,1);render($('filter').value);save();return}
  if(e.target.classList.contains('copy')){navigator.clipboard.writeText(entries[i].v);e.target.textContent='âœ”';setTimeout(()=>e.target.textContent='ðŸ“‹',900)}
  if(e.target.classList.contains('sec')){const p=e.target;p.textContent=p.textContent.includes('â€¢')?entries[i].v:'â€¢'.repeat(entries[i].v.length)}
}
const def = strongPwd();
$('add').onclick=()=>{const k=prompt('Key');if(!k)return;const v=prompt('Value (blank = random)',def)||def;entries.push({k,v});render($('filter').value);save()}

/* save */
async function save(){try{const blob=await enc(entries),body={message:'update',content:b64(new TextEncoder().encode(JSON.stringify(blob))),branch:'main',...(sha&&{sha})},r=await gh(`https://api.github.com/repos/${user}/vault/contents/vault.json`,{method:'PUT',body:JSON.stringify(body)});sha=(await r.json()).content.sha;toast('âœ“Â Saved');}catch(e){alert('Save failed');}}

/* write pass helper */
function writePass(){sessionStorage.setItem(PASS,pass); $('remember').checked?localStorage.setItem(PASS,pass):localStorage.removeItem(PASS)}

/* install PAT */
$('install').onclick=async()=>{
  $('smsg').classList.add('hidden');
  token=$('pat').value.trim();pass=$('spw').value.trim();
  if(!token||!pass){err('smsg','Both fields');return}
  localStorage.setItem(CFG,JSON.stringify(await enc({token})));
  writePass(); unlock(true);
};

/* --- strong random password --- */
function strongPwd(len=24){
  const lowers="abcdefghijklmnopqrstuvwxyz",
        uppers="ABCDEFGHIJKLMNOPQRSTUVWXYZ",
        nums  ="0123456789",
        syms  ="!@#$%^&*()-_=+[]{}";
  const all = lowers+uppers+nums+syms;
  const bytes=new Uint8Array(len);
  crypto.getRandomValues(bytes);
  let pwd=[ lowers[bytes[0]%26],
            uppers[bytes[1]%26],
            nums  [bytes[2]%10],
            syms  [bytes[3]%syms.length] ];
  for(let i=4;i<len;i++) pwd.push(all[bytes[i]%all.length]);
  return pwd.sort(()=>Math.random()-0.5).join('');
}

/* unlock */
$('go').onclick=()=>unlock(false);
async function unlock(installed){
  /* NEW: pull pass from storage on autoâ€‘unlock */
  if(installed){
    pass = sessionStorage.getItem(PASS) || localStorage.getItem(PASS);
  }else{
    pass = sessionStorage.getItem(PASS) || localStorage.getItem(PASS) || $('pw').value.trim();
  }
  if(!pass)return;
  if(!installed){pass=sessionStorage.getItem(PASS)||localStorage.getItem(PASS)||$('pw').value.trim();}
  if(!pass)return;
  const c=cfg();if(!c){$('setup').classList.remove('hidden');return}
  try{token=(await dec(c)).token}catch{err('umsg','Bad pass');return}
  writePass();$('pw').value='';
  user=await fetch('https://api.github.com/user',{headers:{Authorization:`Bearer ${token}`,Accept:API}}).then(r=>r.json()).then(j=>j.login)
  const r=await gh(`https://api.github.com/repos/${user}/vault/contents/vault.json?ref=main`);
  if(r.ok){const j=await r.json(),blob=JSON.parse(atob(j.content));sha=j.sha;try{entries=await dec(blob);}catch{const o=prompt('Old pass to migrate:');if(!o)return;try{pass=o;entries=await dec(blob);pass=sessionStorage.getItem(PASS)||localStorage.getItem(PASS);await save();toast('Vault migrated');}catch{err('umsg','Migration fail');return}}}
  $('setup').classList.add('hidden');$('unlock').classList.add('hidden');$('app').classList.remove('hidden');$('logout').classList.remove('hidden');render();
}

/* logout/uninstall */
$('logout').onclick=()=>{sessionStorage.removeItem(PASS);localStorage.removeItem(PASS);location.reload()}
$('uninstall').onclick=()=>{sessionStorage.clear();localStorage.removeItem(CFG);localStorage.removeItem(PASS);location.reload()}

/* remember live */
$('remember').onchange=()=>{if(!pass)return;$('remember').checked?localStorage.setItem(PASS,pass):localStorage.removeItem(PASS)}

/* initial screen */
if(cfg()){ $('unlock').classList.remove('hidden'); const s=sessionStorage.getItem(PASS),l=localStorage.getItem(PASS); if(s||l){ $('remember').checked=!!l; unlock(true);} } else $('setup').classList.remove('hidden');
function err(id,m){const e=$(id);e.textContent=m;e.classList.remove('hidden')}
}
</script>
