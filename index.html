<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>LosÂ Secretos</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{--bg:#141414;--fg:#f3f3f3;--accent:#009dff;--card:#242424;--gap:.9rem;--br:8px;--mono:'ui-monospace',monospace}
*{box-sizing:border-box;font-family:system-ui,Arial}
body{background:var(--bg);color:var(--fg);margin:1rem;max-width:42rem}
h1{margin:0 0 .5rem;font-size:1.7rem;letter-spacing:.02em}
input,button{width:100%;padding:.55rem;font-size:1rem;border-radius:var(--br);border:1px solid #444;background:#101010;color:var(--fg)}
button{background:var(--accent);cursor:pointer;border:none}
button[disabled]{opacity:.5;cursor:default}
label{display:block;margin-top:var(--gap)}
label.chk{display:flex;align-items:center;gap:.55rem;margin-bottom:var(--gap)}
input[type=checkbox]{width:auto;height:1.1rem;cursor:pointer}
#toolbar{display:flex;gap:.8rem;margin:calc(var(--gap)*1.5) 0 var(--gap)}
#toolbar input{flex:1;font-size:1.05rem}
#toolbar button{flex:0 0 3.2rem}
.card{background:var(--card);border:1px solid #333;border-radius:var(--br);padding:1rem;margin-bottom:var(--gap);position:relative}
.card h2{margin:0 0 .45rem;font-size:1rem}
.card p{margin:0;font-family:var(--mono);word-break:break-all;font-size:.95rem}
.btn{position:absolute;width:1.7rem;height:1.7rem;border:none;border-radius:50%;font-weight:bold;line-height:1.7rem;padding:0;color:#fff;cursor:pointer}
.del{top:.4rem;right:.4rem;background:#e33}
.copy{bottom:.4rem;right:.4rem;background:#666;font-size:.8rem}
.hidden{display:none}
.small{font-size:.9rem;opacity:.8}
a.link{color:var(--accent);text-decoration:none;font-size:.9rem;cursor:pointer}
.err{color:#e55;font-size:.95rem;margin-top:.6rem}
#toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#444;padding:.5rem 1rem;border-radius:var(--br);opacity:0;transition:opacity .3s}
button{background:var(--accent);cursor:pointer;border:none}
#unlock button, #setup button { margin-top: var(--gap); }
button[disabled]{opacity:.5;cursor:default}
</style>

<h1>LosÂ Secretos</h1>
<label class="chk"><input id="remember" type="checkbox"> remember me</label>

<!-- ---------- Setup ---------- -->
<section id="setup" class="hidden">
  <p class="small"><strong>Create a fineâ€‘grained PAT:</strong><br>
     Settingsâ†’DeveloperÂ settingsâ†’Personal access tokensâ†’Fineâ€‘grained<br>
     â€¢ Repos: <code>secretos</code>Â (public) &amp; <code>vault</code>Â (private)<br>
     â€¢ Permissions: <code>Contentsâ€¯RW</code></p>
  <label>PAT <input id="pat" type="password" autocomplete="off"></label>
  <label>Passâ€‘phrase <input id="spw" type="password"></label>
  <button id="gen">GenerateÂ &Â CommitÂ config.enc</button>
  <p id="smsg" class="err hidden"></p>
</section>

<!-- ---------- Unlock ---------- -->
<section id="unlock" class="hidden">
  <label>Passâ€‘phrase <input id="pw" type="password"></label>
  <button id="go">Unlock</button>
  <p id="umsg" class="err hidden"></p>
  <p><a id="showSetup" class="link">Run setup / rotate token</a></p>
</section>

<!-- ---------- Vault ---------- -->
<section id="app" class="hidden">
  <div id="toolbar">
    <input id="filter" placeholder="filterâ€¦">
    <button id="add">ï¼‹</button>
  </div>
  <div id="grid"></div>
</section>

<div id="toast">âœ“Â Saved</div>

<script>
if(!crypto.subtle){alert('Needs https:// or localhost');throw new Error('Insecure context')}

const $=id=>document.getElementById(id),API='application/vnd.github+json',
b64=ab=>btoa(String.fromCharCode(...new Uint8Array(ab))),
ab=s=>Uint8Array.from(atob(s),c=>c.charCodeAt()).buffer

let pass,token,user,sha='',entries=[]
const toast=msg=>{const t=$('toast');t.textContent=msg;t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1200)}

async function key(p,s){const base=await crypto.subtle.importKey('raw',new TextEncoder().encode(p),'PBKDF2',0,['deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt:s,iterations:250e3,hash:'SHA-256'},base,{name:'AES-GCM',length:256},0,['encrypt','decrypt'])}
const encrypt=async o=>{const iv=crypto.getRandomValues(new Uint8Array(12)),salt=crypto.getRandomValues(new Uint8Array(16)),ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},await key(pass,salt),new TextEncoder().encode(JSON.stringify(o)));return{iv:b64(iv),salt:b64(salt),ct:b64(ct)}}
const decrypt=async b=>JSON.parse(new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:ab(b.iv)},await key(pass,ab(b.salt)),ab(b.ct))))
const gh=(u,opt={})=>fetch(u,{...opt,headers:{Authorization:`Bearer ${token}`,Accept:API,'X-GitHub-Api-Version':'2022-11-28'}})

const grid=$('grid')
function render(q=''){grid.innerHTML='';entries.filter(e=>e.k.toLowerCase().includes(q)||e.v.toLowerCase().includes(q)).forEach((e,i)=>{grid.insertAdjacentHTML('beforeend',`<div class="card"><button class="btn del" data-i=${i}>Ã—</button><h2>${e.k}</h2><p class=sec data-i=${i}>${'â€¢'.repeat(e.v.length)}</p><button class="btn copy" data-i=${i}>ðŸ“‹</button></div>`)})}
$('filter').oninput=e=>render(e.target.value.toLowerCase())
grid.onclick=e=>{
  const i=e.target.dataset.i
  if(e.target.classList.contains('del')){entries.splice(i,1);render($('filter').value);save();return}
  if(e.target.classList.contains('copy')){navigator.clipboard.writeText(entries[i].v);e.target.textContent='âœ”';setTimeout(()=>e.target.textContent='ðŸ“‹',900)}
  if(e.target.classList.contains('sec')){const p=e.target;p.textContent=p.textContent.includes('â€¢')?entries[i].v:'â€¢'.repeat(entries[i].v.length)}
}
$('add').onclick=()=>{const k=prompt('Key');if(!k)return;const rand=b64(crypto.getRandomValues(new Uint8Array(18))).slice(0,24);const v=prompt('Value (blank=random)',rand)||rand;entries.push({k,v});render($('filter').value);save()}

async function save(){try{const blob=await encrypt(entries),body={message:'update',content:b64(new TextEncoder().encode(JSON.stringify(blob))),branch:'main',...(sha&&{sha})},r=await gh(`https://api.github.com/repos/${user}/vault/contents/vault.json`,{method:'PUT',body:JSON.stringify(body)});sha=(await r.json()).content.sha;toast('âœ“Â Saved')}catch(err){alert('Save failed');console.error(err)}}

$('gen').onclick=async()=>{ $('smsg').classList.add('hidden'); token=$('pat').value.trim(); pass=$('spw').value.trim(); if(!token||!pass){err('smsg','Both fields required');return}
  try{user=await fetch('https://api.github.com/user',{headers:{Authorization:`Bearer ${token}`,Accept:API}}).then(r=>r.json()).then(j=>j.login)
    const blob=await encrypt({token}),api=`https://api.github.com/repos/${user}/secretos/contents/config.enc`,head=await gh(api);let shaHead='';if(head.ok)shaHead=(await head.json()).sha
    await gh(api,{method:'PUT',body:JSON.stringify({message:'add config.enc',content:b64(new TextEncoder().encode(JSON.stringify(blob))),...(shaHead&&{sha:shaHead})})})
    alert('config.enc committed â€“ reload');location.reload()
  }catch(e){err('smsg','GitHub API error');console.error(e)}}

$('showSetup').onclick=()=>{$('app').classList.add('hidden');$('unlock').classList.add('hidden');$('setup').classList.remove('hidden')}

$('go').onclick=()=>unlock(false)
const autoPass=localStorage.getItem('secretos-pass')
if(autoPass)unlock(true)

async function unlock(auto){
  pass=auto?autoPass:$('pw').value.trim()
  if(!pass)return
  try{token=(await decrypt(await fetch('./config.enc').then(r=>r.json()))).token}catch{ if(!auto)err('umsg','Wrong passâ€‘phrase');return}
  if($('remember').checked) localStorage.setItem('secretos-pass',pass); 
  else localStorage.removeItem('secretos-pass');  user=await gh('https://api.github.com/user').then(r=>r.json()).then(j=>j.login)
  const r = await gh(`https://api.github.com/repos/${user}/vault/contents/vault.json?ref=main`);
  if (r.ok) {
    const j      = await r.json();
    const blob   = JSON.parse(atob(j.content));   // parsed once
    sha          = j.sha;
    const newPass = pass;                         // keep the intended new passâ€‘phrase
    try {
      entries = await decrypt(blob);              // try with new passâ€‘phrase
    } catch {
      const old = prompt('Vault is still encrypted with an older passâ€‘phrase.\nPlease enter the OLD passâ€‘phrase to migrate:');
      if (!old) { err('umsg','Migration cancelled'); return; }
      try {                                       // decrypt with old passâ€‘phrase
        pass    = old;
        entries = await decrypt(blob);
        pass    = newPass;                        // switch back to new passâ€‘phrase
        await save();                             // autoâ€‘reâ€‘encrypt & push
        toast('Vault migrated');                  // confirmation
      } catch { err('umsg','Migration failed'); return; }
    }
  } else {
    entries = [];                                 // first run â€“ empty vault
  }
  $('setup').classList.add('hidden');$('unlock').classList.add('hidden');$('app').classList.remove('hidden');render()
}

function err(id,msg){const e=$(id);e.textContent=msg;e.classList.remove('hidden')}

/* ---------- rememberâ€‘me live toggle ---------- */
$('remember').addEventListener('change', () => {
  if (!pass) return;                            // nothing to store yet
  if ($('remember').checked) localStorage.setItem('secretos-pass', pass);
  else                      localStorage.removeItem('secretos-pass');
});

/* ---------- initial view & rememberâ€‘me ---------- */
const stored = localStorage.getItem('secretos-pass');
if (stored) { $('remember').checked = true; }     // preâ€‘tick box

(async () => {
  const cfg = await fetch('./config.enc').then(r => r.ok).catch(() => false);
  if (cfg) {
    $('unlock').classList.remove('hidden');
    if (stored) unlock(true);                    // autoâ€‘unlock only if remembered
  } else {
    $('setup').classList.remove('hidden');
  }
})();

</script>
