<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Secretos – Generate config.enc</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:sans-serif;margin:2rem;max-width:40rem}
input,button{width:100%;padding:.4rem;margin:.3rem 0}
pre{background:#f5f5f5;padding:.6rem;overflow:auto}
.hidden{display:none}
</style>

<h1>Create <code>config.enc</code></h1>

<label>Fine-grained PAT (Contents RW on <code>secretos</code> and <code>vault</code>)
<input id="pat" type="password" placeholder="ghp_…"></label>

<label>Pass-phrase
<input id="pass" type="password" placeholder="••••••"></label>

<button id="go">Generate & Commit</button>

<pre id="out" class="hidden"></pre>
<p id="done" class="hidden">Committed! Open <a id="link" href="./" target="_blank">your vault</a>.</p>

<script>
const $=id=>document.getElementById(id)
const b64=ab=>btoa(String.fromCharCode(...new Uint8Array(ab)))
const ab=str=>Uint8Array.from(atob(str),c=>c.charCodeAt()).buffer
async function kdf(pass,salt){
  const base=await crypto.subtle.importKey('raw',new TextEncoder().encode(pass),'PBKDF2',0,['deriveKey'])
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:250000,hash:'SHA-256'},
    base,{name:'AES-GCM',length:256},0,['encrypt'])
}
async function enc(obj,pass){
  const iv=crypto.getRandomValues(new Uint8Array(12))
  const salt=crypto.getRandomValues(new Uint8Array(16))
  const key=await kdf(pass,salt)
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(JSON.stringify(obj)))
  return {iv:b64(iv),salt:b64(salt),ct:b64(ct)}
}
function gh(url,tok,opt={}){return fetch(url,{...opt,headers:{'Authorization':'Bearer '+tok,'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'}})}

$('go').onclick=async()=>{
  const token=$('pat').value.trim(),pass=$('pass').value.trim()
  if(!token||!pass){alert('Both fields required');return}
  const login=await gh('https://api.github.com/user',token).then(r=>r.json()).then(j=>j.login)
  const blob=await enc({token},pass)
  const api=`https://api.github.com/repos/${login}/secretos/contents/config.enc`
  let sha=''
  const head=await gh(api,token);if(head.ok) sha=(await head.json()).sha
  const res=await gh(api,token,{method:'PUT',body:JSON.stringify({message:'add config.enc',content:btoa(JSON.stringify(blob)),...(sha&&{sha})})})
  if(!res.ok){alert('Commit failed');return}
  $('out').textContent=JSON.stringify(blob,null,2);$('out').classList.remove('hidden')
  $('link').href=`https://${login}.github.io/secretos/`;$('done').classList.remove('hidden')
}
</script>
